<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civis Test Online</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #282c34;
            color: #61dafb;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        h4 {
            color: #61dafb;
            text-align: center;
            margin-bottom: 20px;
        }
        #vocabLabel {
            font-size: 24px;
            margin: 20px 0;
            border: 2px solid #61dafb;
            padding: 15px;
            text-align: center;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card {
            background-color: #1c2025;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
        }
        .term {
            color: lightgreen;
            font-weight: bold;
            font-size: 20px;
        }
        .ipa {
            color: yellow;
            font-size: 20px;
        }
        .vietnamese {
            color: lightblue;
            font-size: 20px;
        }
        .example {
            color: lightgreen;
            font-size: 22px;
        }
        .example_ipa {
            color: yellow;
            font-size: 18px;
        }
        .example_vi {
            color: lightblue;
            font-size: 18px;
        }
        input, button {
            margin: 5px;
            padding: 10px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
        }
        button {
            background-color: #61dafb;
            color: #282c34;
            cursor: pointer;
            transition: background-color 0.3s;
            flex: 1;
            min-width: 120px;
        }
        button:hover {
            background-color: #21a1f1;
        }
        #questionCounter {
            font-size: 18px;
            color: white;
            text-align: center;
            font-weight: bold;
            margin: 10px 0;
        }
        #answerInput, #writingCheckBack {
            width: 100%;
            margin: 10px 0;
            padding: 12px;
            font-size: 18px;
            border: none;
            border-radius: 4px;
            background-color: #1c2025;
            color: #61dafb;
            box-sizing: border-box;
        }

        /* Container cho các nút kiểm tra */
        .check-buttons-container {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin: 15px 0;
        }
        
        .check-buttons-container button {
            flex: 1;
            padding: 12px;
        }
        
        #notification {
            display: none;
            padding: 10px;
            margin: 10px auto;
            text-align: center;
            border-radius: 4px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
        }

        .control-panel {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
        }

        .control-panel button {
            flex: 1;
            min-width: 110px;
            padding: 10px;
            font-size: 14px;
        }

        #fileInput {
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
            box-sizing: border-box;
        }
        
        #importButton {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
        }

        /* Session selection styles */
        .session-selection {
            background-color: #1c2025;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .session-selection h3 {
            margin: 0 0 10px 0;
            text-align: center;
            color: #61dafb;
        }
        
        .session-inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center; /* Căn giữa các item theo chiều dọc */
        }
        
        /* === THAY ĐỔI BẮT ĐẦU TỪ ĐÂY === */
        .session-inputs input, .session-inputs button {
            padding: 6px 10px; /* Giảm chiều cao padding */
            font-size: 14px;  /* Giảm kích thước chữ */
            margin: 2px;      /* Giảm khoảng cách giữa các nút */
            min-width: 100px; /* Đảm bảo chiều rộng tối thiểu */
        }

        .session-inputs input {
            background-color: #282c34;
            color: #61dafb;
            border: 1px solid #61dafb;
        }
        /* === KẾT THÚC THAY ĐỔI === */

        @media (max-width: 600px) {
            .check-buttons-container {
                flex-direction: column;
            }
            
            .control-panel {
                flex-direction: column;
            }
            
            .control-panel button {
                width: 100%;
            }
            
            #vocabLabel {
                font-size: 20px;
                padding: 10px;
                min-height: 100px;
            }
            
            .term {
                font-size: 24px;
            }
            
            .example {
                font-size: 20px;
            }
            
            .session-inputs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

<div style="text-align: center;">
    <div id="questionCounter">Câu hỏi: 0/0</div>
</div>
<div id="vocabLabel">Không có từ vựng nào được thêm.</div>

<input type="text" id="answerInput" placeholder="Nhập câu trả lời của bạn..." onkeydown="handleKeyDown(event)" />
<input type="text" id="writingCheckBack" placeholder="Nhập câu trả lời mặt sau..." onkeydown="handleKeyDownBack(event)" />

<div class="check-buttons-container">
    <button id="checkAnswerButton" onclick="checkAnswer()">KT Hỏi</button>
    <button id="checkAnswerBackButton" onclick="checkAnswerBack()">KT Đáp</button>
    <button id="toggleQuestionButton" onclick="toggleQuestionVisibility()">Ẩn Câu Hỏi</button>
</div>

<div id="notification"></div>

<div class="control-panel">
    <button onclick="prevWord()">Trước</button>
    <button onclick="flipCard()">Lật Thẻ</button>
    <button onclick="nextWord()">Tiếp Theo</button>
    <button id="autoFlipButton" onclick="toggleAutoFlip()">Tự Động</button>
    <button id="repeatButton" onclick="repeatPronunciation()">Lặp Lại</button>
    <button id="toggleModeButton" onclick="toggleMode()">Thứ Tự</button>
    
    <button id="studyDifficultButton" onclick="studyDifficultWords()">Học câu khó</button>
    <button id="exportDifficultButton" onclick="exportDifficultWords()">Xuất câu khó</button>
</div>

<div class="session-selection">    <input type="file" id="fileInput" accept=".xlsx" />
    <div class="session-inputs">        
        <button id="importButton" onclick="importFile()">Inser File</button>
        <input type="number" id="startIndex" placeholder="Bắt đầu" min="1">
        <input type="number" id="endIndex" placeholder="Kết thúc" min="1">
        <button onclick="setSessionRange()">Áp dụng</button>
        <button onclick="resetSessionRange()">Đặt lại</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>

<script>
    let vocabList = [];
    let currentIndex = 0;
    let difficultWords = [];
    let mistakeCount = {};
    let autoFlip = false;
    let autoFlipTimeout;
    let isFront = true;
    let currentPronunciationText = '';
    let isRandomMode = false;
    let isQuestionVisible = true;
    let usedIndices = new Set();
    let sessionVocabList = [];
    let isSessionActive = false;

    // --- GIẢI PHÁP TỐI ƯU HÓA ÂM THANH (PHIÊN BẢN 5 - HOÀN CHỈNH) ---
    const MAX_TEXT_LENGTH = 190;
    const AUTO_FLIP_DELAY = 4000;
    let audioCache = new Map();
    let currentAudio = null;
    let audioQueue = [];
    let isQueuePlaying = false;

    function splitTextIntoChunks(text) {
        if (!text || text.length === 0) return [];
        if (text.length <= MAX_TEXT_LENGTH) return [text];
        const chunks = [];
        let remainingText = text;
        while (remainingText.length > 0) {
            if (remainingText.length <= MAX_TEXT_LENGTH) {
                chunks.push(remainingText);
                break;
            }
            let splitPos = -1;
            const punctuation = ['.', ',', '?', ';', ':'];
            for (let i = MAX_TEXT_LENGTH; i > 0; i--) {
                if (punctuation.includes(remainingText[i])) {
                    splitPos = i + 1;
                    break;
                }
            }
            if (splitPos === -1) splitPos = remainingText.lastIndexOf(' ', MAX_TEXT_LENGTH);
            if (splitPos === -1) splitPos = MAX_TEXT_LENGTH;
            chunks.push(remainingText.substring(0, splitPos));
            remainingText = remainingText.substring(splitPos).trim();
        }
        return chunks;
    }

    function getAndCacheAudio(text) {
        if (audioCache.has(text)) return audioCache.get(text);
        const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(text)}&tl=en&client=gtx`;
        const newAudio = new Howl({
            src: [url],
            html5: true,
            onloaderror: (id, err) => console.error("Lỗi tải âm thanh:", text, err)
        });
        audioCache.set(text, newAudio);
        return newAudio;
    }

    function stopAllAudio() {
        isQueuePlaying = false;
        if (currentAudio) currentAudio.stop();
        audioQueue = [];
        clearTimeout(autoFlipTimeout);
    }

    /**
     * Hàm chính để phát âm thanh, có hỗ trợ callback khi hoàn thành.
     * @param {string} text - Văn bản cần phát.
     * @param {boolean} isForAutoFlip - Cờ cho chu trình tự động.
     * @param {Function} onCompleteCallback - Hàm sẽ được gọi khi phát xong toàn bộ.
     */
    function playText(text, isForAutoFlip = false, onCompleteCallback = null) {
        stopAllAudio();
        currentPronunciationText = text;
        const chunks = splitTextIntoChunks(text);
        if (chunks.length === 0) {
             if(onCompleteCallback) onCompleteCallback();
             return;
        };
        audioQueue = chunks.map(chunk => getAndCacheAudio(chunk.trim()));
        if (audioQueue.length > 0) {
            isQueuePlaying = true;
            playNextInQueue(isForAutoFlip, onCompleteCallback);
        }
    }
    
    function handlePlaybackCompletion(isForAutoFlip, onCompleteCallback) {
        isQueuePlaying = false;
        if (onCompleteCallback) {
            onCompleteCallback();
        }
        if (isForAutoFlip && autoFlip) {
            if (isFront) {
                autoFlipTimeout = setTimeout(flipCard, AUTO_FLIP_DELAY);
            } else {
                autoFlipTimeout = setTimeout(nextWord, AUTO_FLIP_DELAY);
            }
        }
    }

    function playNextInQueue(isForAutoFlip, onCompleteCallback) {
        if (!isQueuePlaying) return;
        currentAudio = audioQueue.shift();
        if (currentAudio) {
            currentAudio.off('end');
            currentAudio.on('end', () => {
                if (audioQueue.length > 0) {
                    playNextInQueue(isForAutoFlip, onCompleteCallback);
                } else {
                    handlePlaybackCompletion(isForAutoFlip, onCompleteCallback);
                }
            });
            currentAudio.play();
        } else {
            handlePlaybackCompletion(isForAutoFlip, onCompleteCallback);
        }
    }
    // --- KẾT THÚC PHẦN TỐI ƯU HÓA ---

    function toggleQuestionVisibility() {
        isQuestionVisible = !isQuestionVisible;
        const questionElement = document.getElementById('vocabLabel');
        const toggleButton = document.getElementById('toggleQuestionButton');
        if (isQuestionVisible) {
            questionElement.style.display = 'flex';
            toggleButton.innerText = 'Ẩn Câu Hỏi';
            displayWord();
        } else {
            questionElement.style.display = 'none';
            toggleButton.innerText = 'Hiện Câu Hỏi';
        }
    }

    function toggleMode() {
        isRandomMode = !isRandomMode;
        document.getElementById("toggleModeButton").innerText = isRandomMode ? "Ngẫu Nhiên" : "Thứ Tự";
        if (isRandomMode && vocabList.length > 0) {
            usedIndices.clear();
            usedIndices.add(currentIndex);
        }
    }

    document.getElementById('importButton').addEventListener('click', importFile);
    document.addEventListener('keydown', e => {
        switch (e.key) {
            case 'ArrowLeft': prevWord(); break;
            case 'ArrowRight': nextWord(); break;
            case 'ArrowDown': flipCard(); break;
            case 'ArrowUp': repeatPronunciation(); break;
        }
    });

    function handleKeyDown(event) { if (event.key === 'Enter') checkAnswer(); }
    function handleKeyDownBack(event) { if (event.key === 'Enter') checkAnswerBack(); }

    function showNotification(message, isCorrect) {
        const notification = document.getElementById('notification');
        notification.innerText = message;
        notification.style.display = 'block';
        notification.style.color = '#ffffff';
        notification.style.backgroundColor = isCorrect ? '#4caf50' : '#f44336';
        setTimeout(() => { notification.style.display = 'none'; }, 2000);
    }

    function updateQuestionCounter() {
        const questionCounter = document.getElementById('questionCounter');
        const currentList = isSessionActive ? sessionVocabList : vocabList;
        questionCounter.innerText = `Câu hỏi: ${currentIndex + 1}/${currentList.length}`;
    }

    function importFile() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        if (!file) { alert("Vui lòng chọn một file .xlsx!"); return; }
        const reader = new FileReader();
        reader.onload = function (event) {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            vocabList = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
            stopAllAudio();
            audioCache.clear();
            if (vocabList.length > 0) {
                vocabList.shift();
                currentIndex = 0;
                usedIndices.clear();
                isSessionActive = false;
                document.getElementById('endIndex').value = vocabList.length;
                displayWord();
            } else {
                document.getElementById('vocabLabel').innerText = "Không tìm thấy từ vựng nào.";
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function displayWord() {
        const currentList = isSessionActive ? sessionVocabList : vocabList;
        if (currentList.length > 0 && currentIndex < currentList.length) {
            const word = currentList[currentIndex];
            const frontCard = `<div class="card"><span class="term">${word[0]}</span><br><span class="ipa">${word[1]}</span><br><span class="vietnamese">${word[2]}</span><br></div>`;
            const backCard = `<div class="card"><span class="example">${word[3]}</span><br><span class="example_ipa">${word[4]}</span><br><span class="example_vi">${word[5]}</span></div>`;
            document.getElementById('vocabLabel').innerHTML = isFront ? frontCard : backCard;
            document.getElementById('vocabLabel').style.display = isQuestionVisible ? 'flex' : 'none';
            const textToPlay = (isFront ? word[0] : word[3])?.toString() || '';
            playText(textToPlay, true);
            const otherSideText = (isFront ? word[3] : word[0])?.toString() || '';
            splitTextIntoChunks(otherSideText).forEach(chunk => getAndCacheAudio(chunk.trim()));
            if (currentList.length > 1 && !isRandomMode) {
                const nextIndex = (currentIndex + 1) % currentList.length;
                const nextWordData = currentList[nextIndex];
                const nextFrontText = nextWordData?.[0]?.toString() || '';
                splitTextIntoChunks(nextFrontText).forEach(chunk => getAndCacheAudio(chunk.trim()));
            }
        } else {
            document.getElementById('vocabLabel').innerText = "Tất cả từ vựng đã hoàn thành.";
        }
        updateQuestionCounter();
    }

    function repeatPronunciation() {
        if (!isQueuePlaying && currentPronunciationText) {
            playText(currentPronunciationText);
        } else if (currentAudio) {
            currentAudio.play();
        }
    }

    function getRandomUnusedIndex() {
        const currentList = isSessionActive ? sessionVocabList : vocabList;
        if (usedIndices.size >= currentList.length) usedIndices.clear();
        let availableIndices = Array.from({ length: currentList.length }, (_, i) => i).filter(i => !usedIndices.has(i));
        if (availableIndices.length === 0) return 0;
        const randomIndex = Math.floor(Math.random() * availableIndices.length);
        return availableIndices[randomIndex];
    }

    function nextWord() {
        const currentList = isSessionActive ? sessionVocabList : vocabList;
        if (currentList.length === 0) return;
        if (isRandomMode) {
            const newIndex = getRandomUnusedIndex();
            usedIndices.add(newIndex);
            currentIndex = newIndex;
        } else {
            currentIndex = (currentIndex + 1) % currentList.length;
        }
        isFront = true;
        displayWord();
    }

    function prevWord() {
        const currentList = isSessionActive ? sessionVocabList : vocabList;
        if (currentList.length === 0) return;
        if (isRandomMode) {
            const newIndex = getRandomUnusedIndex();
            usedIndices.add(newIndex);
            currentIndex = newIndex;
        } else {
            currentIndex = (currentIndex - 1 + currentList.length) % currentList.length;
        }
        isFront = true;
        displayWord();
    }

    function flipCard() {
        isFront = !isFront;
        displayWord();
    }
    
    function flipCardToBack() {
        if (isFront) {
            isFront = false;
            displayWord();
        }
    }

    function toggleAutoFlip() {
        autoFlip = !autoFlip;
        const button = document.getElementById('autoFlipButton');
        button.innerText = autoFlip ? "Tắt Tự Động" : "Tự Động";
        if (autoFlip) {
            alert("Chế độ tự động đã bật.");
            if (!isQueuePlaying) {
                handlePlaybackCompletion(true, null);
            }
        } else {
            alert("Chế độ tự động đã tắt.");
            stopAllAudio();
        }
    }

    function removePunctuation(text) {
        return text ? text.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()?]/g, '').replace(/\s{2,}/g, ' ') : '';
    }

    function checkAnswer() {
        const currentList = isSessionActive ? sessionVocabList : vocabList;
        const userAnswer = removePunctuation(document.getElementById('answerInput').value.toString().trim().toLowerCase());
        const word = currentList[currentIndex];
        const correctAnswerText = (isFront ? word[0] : word[3])?.toString() || '';
        const correctAnswer = removePunctuation(correctAnswerText.trim().toLowerCase());
        if (userAnswer === correctAnswer) {
            showNotification("Đúng!", true);
            if (isFront) flipCard(); else nextWord();
        } else {
            showNotification("Sai!", false);
            playText(correctAnswerText);
            const currentWordKey = word.join('|');
            mistakeCount[currentWordKey] = (mistakeCount[currentWordKey] || 0) + 1;
            if (mistakeCount[currentWordKey] >= 2) markAsDifficult(word);
        }
        document.getElementById('answerInput').value = '';
    }

    function checkAnswerBack() {
        const currentList = isSessionActive ? sessionVocabList : vocabList;
        const currentExampleText = currentList[currentIndex][3]?.toString() || '';
        const currentExample = removePunctuation(currentExampleText.trim().toLowerCase());
        const userAnswerBack = removePunctuation(document.getElementById("writingCheckBack").value.trim().toLowerCase());
        document.getElementById("writingCheckBack").value = "";

        if (userAnswerBack === currentExample) {
            showNotification("Đúng!", true);
            flipCardToBack();
            
            // Chờ 3 giây SAU KHI phát âm xong rồi mới chuyển từ
            const onAudioComplete = () => {
                setTimeout(nextWord, 3000);
            };
            
            playText(currentExampleText, false, onAudioComplete);

        } else {
            showNotification("Sai!", false);
            flipCardToBack();
            playText(currentExampleText);
            const currentWordKey = currentList[currentIndex].join('|');
            mistakeCount[currentWordKey] = (mistakeCount[currentWordKey] || 0) + 1;
            if (mistakeCount[currentWordKey] >= 2) markAsDifficult(currentList[currentIndex]);
        }
    }

    function markAsDifficult(word) {
        if (!difficultWords.some(w => w.join('|') === word.join('|'))) {
            difficultWords.push(word);
            saveDifficultWords();
            alert("Từ này đã được đánh dấu là khó!");
        }
    }

    function saveDifficultWords() { localStorage.setItem('difficultWords', JSON.stringify(difficultWords)); }
    function loadDifficultWords() {
        const savedWords = localStorage.getItem('difficultWords');
        if (savedWords) difficultWords = JSON.parse(savedWords);
    }

    function studyDifficultWords() {
        if (difficultWords.length > 0) {
            vocabList = [...difficultWords];
            isSessionActive = false;
            currentIndex = 0;
            usedIndices.clear();
            displayWord();
            alert("Chuyển sang chế độ học câu khó!");
        } else {
            alert("Không có câu nào được đánh dấu là khó!");
        }
    }

    function exportDifficultWords() {
        if (difficultWords.length === 0) { alert("Không có câu nào được đánh dấu là khó!"); return; }
        const workbook = XLSX.utils.book_new();
        const worksheet = XLSX.utils.json_to_sheet(difficultWords.map(row => [row[0], row[1], row[2], row[3], row[4], row[5]]));
        XLSX.utils.book_append_sheet(workbook, worksheet, "Câu khó");
        XLSX.writeFile(workbook, "difficult_words.xlsx");
        alert("Danh sách câu khó đã được xuất thành file Excel!");
    }

    function setSessionRange() {
        let start = parseInt(document.getElementById('startIndex').value) || 1;
        let end = parseInt(document.getElementById('endIndex').value) || vocabList.length;
        if (start < 1) start = 1;
        if (end > vocabList.length) end = vocabList.length;
        if (start > end) { alert("Giá trị bắt đầu không thể lớn hơn giá trị kết thúc!"); return; }
        sessionVocabList = vocabList.slice(start - 1, end);
        isSessionActive = true;
        currentIndex = 0;
        usedIndices.clear();
        displayWord();
        alert(`Đã thiết lập phiên học từ câu ${start} đến câu ${end} (tổng cộng ${sessionVocabList.length} câu)`);
    }

    function resetSessionRange() {
        isSessionActive = false;
        currentIndex = 0;
        usedIndices.clear();
        displayWord();
        alert("Đã hiển thị tất cả từ vựng.");
    }

    window.onload = function () {
        loadDifficultWords();
    };
</script>
</body>
</html>